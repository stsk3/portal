<html>

<head>    
    <link rel="stylesheet" href="main.css">
    <script type="text/javascript" src="script/jquery-3.3.1.js"></script>
    <link rel="stylesheet" href="script/jquery.dataTables.min.css" />
    <script type="text/javascript" src="script/jquery.dataTables.min.js"></script>
    <style></style>
    <script>
        const busStopMap = {};
        const busStopGroupMap = {};
        const refreshMap = {};  
        const refreshInterval = 30000;

        function getRouteList() {
            clearRefreshMap();
            $('#busRouteInfo').hide();
            $('#loadingDiv').show();

            const tableId = '#listTable';

            //Destroy old data
            $(tableId + " > tbody").html("");


            $.ajax({url: "https://data.etabus.gov.hk/v1/transport/kmb/route/", cache: true, success: 
                function (data) {
                    const jsonData = data;

                    const records = jsonData.data;
                    if (records.length > 0) {
                        var html = '<thead>';
                        html += '<tr>';
                        html += '<th>è·¯ç·š</th>';
                        html += '<th>èµ·é»</th>';
                        html += '<th>çµ‚é»</th>';
                        html += '</tr>';
                        html += '</thead>';

                        if ($.fn.DataTable.isDataTable(tableId)) {
                            const dt = $(tableId).DataTable();
                            dt.columns(0).header().to$().text('è·¯ç·š');
                            dt.columns(1).header().to$().text('èµ·é»');
                            dt.columns(2).header().to$().text('çµ‚é»');
                        }

                        html += '<tbody>';
                        $.each(records, function (index, record) {
                            const route = record.route;
                            const orig = record.orig_tc;
                            const dest = record.dest_tc;
                            const bound = record.bound;
                            const serviceType = record.service_type;

                            html += `<tr onclick="getRouteBusStopList('${route}', '${bound}', '${serviceType}')">`;
                            html += '<td>' + record.route + '</td>';
                            html += '<td>' + record.orig_tc + '</td>';
                            html += '<td>' + record.dest_tc + '</td>';
                            html += '</tr>';
                        });
                        html += '</tbody>';


                        $(tableId).html(html);

                        initDataTable(tableId);
                   }
             }});
        }


        function getBusStopList() {
            clearRefreshMap();
            $('#busRouteInfo').hide();
            $('#loadingDiv').show();

            const tableId = '#listTable';

            //Destroy old data
            $(tableId + " > tbody").html("");

            setTimeout(function(){ 
                if ($.fn.DataTable.isDataTable(tableId)) {
                    const dt = $(tableId).DataTable();
                    dt.columns(0).header().to$().text('æ•¸é‡');
                    dt.columns(1).header().to$().text('å·´å£«ç«™');
                    dt.columns(2).header().to$().text('Bus Stop');
                }

                var html = '<tbody>';
                for (const [key, value] of Object.entries(busStopGroupMap)) {
                    const name = key;
                    const nameEn = value[0].nameEn;
                    const listLength = value.length;

                    html += `<tr onclick="getBusStopETA('${name}')">`;
                    html += '<td>' + listLength + '</td>';
                    html += '<td>' + name + '</td>';
                    html += '<td>' + nameEn + '</td>';
                    html += '</tr>';
                }
                html += '</tbody>';

                $(tableId).html(html);

                initDataTable(tableId);

                $('#loadingDiv').hide();
            }, 100);
       }


        function getRouteBusStopList(route, bound, serviceType) {
            clearRefreshMap();
            $('#loadingDiv').show();

            $.ajax({url: `https://data.etabus.gov.hk/v1/transport/kmb/route-stop/${route}/${bound == "I" ? "inbound" : "outbound"}/${serviceType}`, cache: true, success: 
                function (data) {
                    const jsonData = data;

                    const records = jsonData.data;
                    if (records.length > 0) {
                        var html = '';
                        $.each(records, function (index, record) {
                            const route = record.route;
                            const seq = record.seq;
                            const stop = record.stop;

                            const busStopName = busStopMap[stop].name;
                            const busStopLat = busStopMap[stop].lat;
                            const busStopLong = busStopMap[stop].long;

                            html += `<div class="busStopDiv">
                                               <span>
                                                   <span class="busStopDiv-seq">${seq}.</span>
                                                   <span class="busStopDiv-name" onclick="getRouteETA('${route}', '${bound}', '${serviceType}', '${stop}', '${seq}')">${busStopName}</span>
                                                   <span class="busStopDiv-other" onclick="getRouteBusStopETA('${stop}', '${seq}')">ğŸšğŸšŒ</span>
                                                   <span class="busStopDiv-map" onclick="window.open('https://maps.google.com/?q=${busStopLat},${busStopLong}', '_blank')">ğŸ“Œ</span>
                                               </span>
                                           </div>`;
                            html += `<div id="${seq}-${stop}" class="etaDiv"></div>`;
                            $("#busRouteInfo-Title").html("è·¯ç·š: ");
                            $("#busRouteInfo-Data").html(route);
                        });

                        $("#busStopList").html(html);
                        $('#busRouteInfo').show();
                   }
             }});
        }


        function getBusStopETA(name) {
            clearRefreshMap();
            $('#loadingDiv').show();

            const busStopGroupList = busStopGroupMap[name];
            const busStopName = name;

            $("#busRouteInfo-Title").html("å·´å£«ç«™: ");
            $("#busRouteInfo-Data").html(busStopName);
            $('#busRouteInfo').show();

            var html = '';
            for (var i = 0; i < busStopGroupList.length; i++) {
                const busStop = busStopGroupList[i];
                const stop = busStop.stop;
                const lat = busStop.lat;
                const long = busStop.long;

                html += `<div class="busStopTitle">ç«™ç‰Œ${i+1} <span onclick="window.open('https://maps.google.com/?q=${lat},${long}', '_blank')">ğŸ“Œ</span></div>`;
                html += `<div class="busStopDiv">`
                html += `<div id="0-${stop}" class="etaDiv bus-stop"></div>`;
                html += `</div>`;

                getRouteBusStopETA(stop, 0);
            }

            $("#busStopList").html(html);
        }


        function getRouteETA(route, bound, serviceType, stop, seq) {
            const id = seq + '-' + stop;

            if (refreshMap[id + '-stopEta']  !== undefined) {
                clearInterval(refreshMap[id + '-stopEta']);
                refreshMap[id + '-stopEta'] = undefined;
            }

            $.ajax({url: `https://data.etabus.gov.hk/v1/transport/kmb/eta/${stop}/${route}/${serviceType}`, cache: false, success: 
                function (data) {
                    const jsonData = data;

                    const records = jsonData.data;
                    if (records.length > 0) {
                        var isFirst = true;
                        var html = '';
                        $.each(records, function (index, record) {
                            const route = record.route;
                            const dir = record.dir;
                            const etaSeq = record.eta_seq;
                            const eta = record.eta;
                            const stopSeq = record.seq;
                            const rmk = record.rmk_tc;
                            const dataTimestamp = record.data_timestamp;

                            if (dir == bound && seq == stopSeq) {
                                var timeGap = "";
                                if (eta) timeGap = millisToMinutesAndSeconds(new Date(eta) - new Date(dataTimestamp));
                                else if (rmk != "æš«åœé å ±") timeGap = "æš«æ™‚æ²’æœ‰é å®šç­æ¬¡";
                                html += `<div><span class="eta-detail seq${isFirst ? '1' : etaSeq}">${timeGap}</span> ${rmk}</div>`;
                                isFirst = false;
                            }
                        });

                        $(`#${id}`).show();
                        $(`#${id}`).html(html);

                        if (refreshMap[id + '-eta'] === undefined) {
                            var interval = setInterval(function() { getRouteETA(route, bound, serviceType, stop, seq); }, refreshInterval);
                            refreshMap[id + '-eta'] = interval;
                        }
                   }
             }});
        }



        function getRouteBusStopETA(stop, seq) {
            const id = seq + '-' + stop;

            if (refreshMap[id + '-eta']  !== undefined) {
                clearInterval(refreshMap[id + '-eta']);
                refreshMap[id + '-eta']  = undefined;
            }

            $.ajax({url: `https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/${stop}`, cache: false, success: 
                function (data) {
                    const jsonData = data;

                    const records = jsonData.data;
                    if (records.length > 0) {
                        var html = '';
                        $.each(records, function (index, record) {
                            const route = record.route;
                            const dir = record.dir;
                            const etaSeq = record.eta_seq;
                            const eta = record.eta;
                            const stopSeq = record.seq;
                            const rmk = record.rmk_tc;
                            const dest = record.dest_tc;
                            const dataTimestamp = record.data_timestamp;

                            var timeGap = "";
                            if (eta) timeGap = millisToMinutesAndSeconds(new Date(eta) - new Date(dataTimestamp));
                            else if (rmk != "æš«åœé å ±") timeGap = "æš«æ™‚æ²’æœ‰é å®šç­æ¬¡";
                            html += `<div><span class="eta-detail-route">${route}</span> å¾€${dest}(${stopSeq}) <span class="eta-detail seq${etaSeq}">${timeGap}</span>  ${rmk}</div>`;
                        });

                        $(`#${id}`).show();
                        $(`#${id}`).html(html);

                        if (refreshMap[id + '-stopEta'] === undefined) {
                            var interval = setInterval(function() { getRouteBusStopETA(stop, seq); }, refreshInterval);
                            refreshMap[id + '-stopEta'] = interval;
                        }
                   }
             }});
        }


        function initBusStop() {
            $('#loadingDiv').show();
            $.getJSON("https://data.etabus.gov.hk/v1/transport/kmb/stop",
                function (data) {
                    const jsonData = data;

                    const records = jsonData.data;
                    $.each(records, function (index, record) {
                        const stop = record.stop;
                        const name = record.name_tc;
                        const nameEn = record.name_en;
                        const lat = record.lat;
                        const long = record.long;

                        busStopMap[stop] = { 'name': name, 'nameEn': nameEn, 'lat': lat, 'long': long };

                        var busStopGroupList = busStopGroupMap[name];
                        if (busStopGroupList == undefined) {
                            busStopGroupList = [];
                            busStopGroupMap[name] = busStopGroupList;
                        }
                        busStopGroupList.push({'stop': stop, 'nameEn': nameEn, 'lat': lat, 'long': long });
                    });
             });
        }


        function initDataTable(id) {
            if ($.fn.DataTable.isDataTable(id))
                $(id).DataTable().destroy();

            $(id).DataTable({
                "order": [],
                paging: true,
                "info": false,
                "columnDefs": [
                    { "className": "dt-center", "targets": "_all" }
                ]
            });

            $('#menu-button').show();
            $('.bus-eta-page .dataTables_wrapper .dataTables_filter input').focus()
        }

        function clearRefreshMap() {
            for (const [key, value] of Object.entries(refreshMap)) {
                clearInterval(refreshMap[key]);
                refreshMap[key] = undefined;
            }
        }

        $(document).ready(function () {
            initBusStop();
            getRouteList();
        });


        $(document).ajaxStart(function () {
            //$('#loadingDiv').show();
        });

        $(document).ajaxComplete(function () {
            $('#loadingDiv').hide();
        });

        function millisToMinutesAndSeconds(millis) {
           if (millis > 0) { 
               var minutes = Math.floor(millis / 60000);
               var seconds = ((millis % 60000) / 1000).toFixed(0);
               return minutes + "åˆ†" + (seconds < 10 ? '0' : '') + seconds+ "ç§’";
           } else {
               return "";
           }
        }


    </script>
</head>

<body class="bus-eta-page">
    <div id="menu-button">
        <button onclick="getRouteList()">å·´å£«è·¯ç·š</button>
        <button onclick="getBusStopList()">å·´å£«ç«™</button>
    </div>
    <br/>
    <div id="loadingDiv">
        Loading...
    </div>
    <div>
        <table id="listTable" class="dataTable display"></table>
        <div id="busRouteInfo">
            <span id="busRouteInfo-Title"></span>
            <span id="busRouteInfo-Data"></span>
            <div id="busStopList"></div>
        </div>
    </div>

    <object type="text/html" data="footer.html"></object>
</body>

</html>
