<html>

<head>    
    <script type="text/javascript" src="script/jquery-3.3.1.js"></script>
    <link rel="stylesheet" href="script/jquery.dataTables.min.css" />
    <script type="text/javascript" src="script/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="script/leaflet.css" />
    <script src="script/leaflet.js"></script>
    <link rel="stylesheet" href="main.css">
    <style></style>
    <script>
        var leafletMap;
        var leafletMapMarkerMap = {};

        const busStopMap = {};
        const busStopGroupMap = {};
        const refreshMap = {};  
        const refreshInterval = 30000;


        const regex = /\([A-Z]\d{1,2}\)/;

        var searchValue = "";
        var userLng = -1;
        var userLat = -1;

        function getRouteList() {
            clearRefreshMap();
            $('.busRouteInfo').hide();
            clearMarkersFromMap();
            $('#loadingDiv').show();

            const tableId = '#listTable';

            //Destroy old data
            $(tableId + " > tbody").html("");


            $.ajax({url: "https://data.etabus.gov.hk/v1/transport/kmb/route/", cache: true, success: 
                function (data) {
                    const jsonData = data;

                    const records = jsonData.data;
                    if (records.length > 0) {
                        var html = '<thead>';
                        html += '<tr>';
                        html += '<th>Ë∑ØÁ∑ö</th>';
                        html += '<th>Ëµ∑Èªû</th>';
                        html += '<th>‚ûî ÁµÇÈªû</th>';
                        html += '</tr>';
                        html += '</thead>';

                        if ($.fn.DataTable.isDataTable(tableId)) {
                            const dt = $(tableId).DataTable();
                            dt.columns(0).header().to$().text('Ë∑ØÁ∑ö');
                            dt.columns(1).header().to$().text('Ëµ∑Èªû');
                            dt.columns(2).header().to$().text('‚ûî ÁµÇÈªû');
                        }

                        html += '<tbody>';
                        $.each(records, function (index, record) {
                            const route = record.route;
                            const orig = record.orig_tc;
                            const dest = record.dest_tc;
                            const bound = record.bound;
                            const serviceType = record.service_type;

                            html += `<tr ${serviceType != 1 ? 'style="color: #BBBBBB"' : ''} onclick="clearRefreshMap(); getRouteBusStopList('${route}', '${bound}', '${serviceType}', '${dest}')">`;
                            html += '<td class="highlight">' + record.route + `${serviceType != 1 ? "*" : ""}</td>`;
                            html += '<td>' + record.orig_tc + '</td>';
                            html += '<td class="highlight">‚ûî ' + record.dest_tc + '</td>';
                            html += '</tr>';
                        });
                        html += '</tbody>';


                        $(tableId).html(html);

                        initDataTable(tableId);

                        $('#loadingDiv').hide();

                        $('#leaflet-map').show();
                        initMap();
                        setMapDefaultView();
                   }
             }});
        }


        function getBusStopList() {
            clearRefreshMap();
            $('.busRouteInfo').hide();
            clearMarkersFromMap();
            $('#leaflet-map').hide();
            $('#loadingDiv').show();

            const tableId = '#listTable';

            //Destroy old data
            $(tableId + " > tbody").html("");

            setTimeout(function(){ 
                var html = '<thead>';
                html += '<tr>';
                html += '<th>Êï∏Èáè</th>';
                html += '<th>Â∑¥Â£´Á´ô</th>';
                html += '<th>Bus Stop</th>';
                html += '</tr>';
                html += '</thead>';

                if ($.fn.DataTable.isDataTable(tableId)) {
                    const dt = $(tableId).DataTable();
                    dt.columns(0).header().to$().text('Êï∏Èáè');
                    dt.columns(1).header().to$().text('Â∑¥Â£´Á´ô');
                    dt.columns(2).header().to$().text('Bus Stop');
                }

                html += '<tbody>';
                for (const [key, value] of Object.entries(busStopGroupMap)) {
                    const name = key;
                    const nameEn = value[0].nameEn;
                    const listLength = value.length;

                    html += `<tr onclick="clearRefreshMap(); getBusStopETA('${name}', 'busStopList')">`;
                    html += '<td>' + listLength + '</td>';
                    html += '<td>' + name + '</td>';
                    html += '<td>' + nameEn + '</td>';
                    html += '</tr>';
                }
                html += '</tbody>';

                $(tableId).html(html);

                initDataTable(tableId);

                $('#loadingDiv').hide();
            }, 100);
       }


        function getRouteBusStopList(route, bound, serviceType, dest) {
            $('#loadingDiv').show();

            clearMarkersFromMap();
            const mapPoints = [];

            $.ajax({url: `https://data.etabus.gov.hk/v1/transport/kmb/route-stop/${route}/${bound == "I" ? "inbound" : "outbound"}/${serviceType}`, cache: true, success: 
                function (data) {
                    const jsonData = data;

                    const records = jsonData.data;
                    if (records.length > 0) {
                        var minDistance = 9999999;
                        var minDistanceSeq = -1;

                        var html = '';
                        $.each(records, function (index, record) {
                            const route = record.route;
                            const seq = record.seq;
                            const stop = record.stop;

                            const busStopName = busStopMap[stop].name;
                            const busStopLat = busStopMap[stop].lat;
                            const busStopLong = busStopMap[stop].long;
                            const divId = seq + "-" + stop;

                            var busStopGroupName = busStopName;
                            var platform = busStopGroupName.match(regex);
                            if (platform) {
                                platform = platform[0];
                                busStopGroupName = busStopGroupName.replace(platform, '').trim();
                                platform = platform.replace('(', '').replace(')', '').trim();
                                busStopGroupName = busStopGroupName + "(" + platform[0] + ")";
                            }

                            const mapPopupName = seq + " " + busStopName;
                            mapPoints.push([busStopLat, busStopLong, mapPopupName]); 

                            const distance = calcCrow(busStopLat, busStopLong);

                            if (distance != -1 && distance < minDistance) {
                                minDistance = distance;
                                minDistanceSeq = seq;
                            }

                            html += `<div class="busStopDiv" id="busStopDiv-${seq}">
                                               <span>
                                                   <span class="busStopDiv-seq">${seq}.</span>
                                                   <span class="busStopDiv-name" onclick="getRouteETA('${route}', '${bound}', '${serviceType}', '${stop}', '${seq}'); selectMarker('${mapPopupName}');">${busStopName}</span>
                                                   <span class="busStopDiv-other" onclick="getBusStopETA('${busStopGroupName}', '${divId}'); selectMarker('${mapPopupName}'); ">üöèüöå</span>
                                                   <span class="busStopDiv-map" onclick="window.open('https://maps.google.com/?q=${busStopLat},${busStopLong}', '_blank')">üìå</span>
                                                   <span class="busStopDiv-distance">${distance != -1 ? distance + "Á±≥": ""}</span>
                                               </span>
                                               <div id="${divId}-refresh" class="refreshDiv"></div>
                                           </div>`;
                            html += `<div id="${divId}" class="etaDiv"></div>`;
                            $("#busRouteInfo-Title").html("Ë∑ØÁ∑ö: ");
                            $("#busRouteInfo-Data").html(route + " ‚ûî" + dest);
                        });

                        $("#busStopList").html(html);
                        $(`#busStopDiv-${minDistanceSeq}`).addClass("red");
                        $('.busRouteInfo').show();

                        addMarkersToMap(mapPoints);
                   }
             }});
        }


        function getBusStopETA(name, id) {
            if (refreshMap[id + '-eta']  !== undefined) {
                clearInterval(refreshMap[id + '-eta']);
                delete refreshMap[id + '-eta'];
            }

            const busStopGroupList = busStopGroupMap[name];
            const busStopName = name;

            $('#loadingDiv').show();

            var html = '';
            for (var i = 0; i < busStopGroupList.length; i++) {
                const busStop = busStopGroupList[i];
                const stop = busStop.stop;
                const lat = busStop.lat;
                const long = busStop.long;
                const platform = busStop.platform;
                const divId = "0-" + stop;

                html += `<div class="busStopTitle">
                                 ÊúàÂè∞${platform ? platform : i+1}
                                 <span onclick="window.open('https://maps.google.com/?q=${lat},${long}', '_blank')">üìå</span>
                                 <div id="${divId}-refresh" class="refreshDiv"></div>
                             </div>`;
                html += `<div class="busStopDiv">`
                html += `<div id="${divId}" class="etaDiv"></div>`;
                html += `</div>`;

                getRouteBusStopETA(stop);
            }


            if (refreshMap[id + '-stopEta'] === undefined) {
                //Bus stop page
                if (id == 'busStopList') {
                    $("#busRouteInfo-Title").html("Â∑¥Â£´Á´ô: ");
                    $("#busRouteInfo-Data").html(busStopName);
                    $('.busRouteInfo').show();
                //Route page
                } else {
                    if (refreshMap[id + '-eta']  !== undefined) {
                        clearInterval(refreshMap[id + '-eta']);
                        delete refreshMap[id + '-eta'];
                   }

                   $(`#${id}-refresh`).html("");
                   $("#" + id).show();
               }

                $("#" + id).html(html); //Only for the first time, for interval triggered -> only update ETA

                var interval = setInterval(function() { getBusStopETA(name, id); }, refreshInterval);
                refreshMap[id + '-stopEta'] = interval;
            }
        }


        function getRouteETA(route, bound, serviceType, stop, seq) {
            const id = seq + '-' + stop;

            $.ajax({url: `https://data.etabus.gov.hk/v1/transport/kmb/eta/${stop}/${route}/${serviceType}`, cache: false, success: 
                function (data) {
                    const jsonData = data;
                    const currentTimestamp = jsonData.generated_timestamp;

                    const records = jsonData.data;
                    if (records.length > 0) {
                        var isFirst = true;
                        var html = '';
                        $.each(records, function (index, record) {
                            const route = record.route;
                            const dir = record.dir;
                            const etaSeq = record.eta_seq;
                            const eta = record.eta;
                            const stopSeq = record.seq;
                            const rmk = record.rmk_tc;
                            const dataTimestamp = record.data_timestamp;

                            if (dir == bound && seq == stopSeq) {
                                var etaText;
                                if (eta) etaText = eta;
                                else if (rmk != "Êö´ÂÅúÈ†êÂ†±") etaText = "Êö´ÊôÇÊ≤íÊúâÈ†êÂÆöÁè≠Ê¨°";
                                html += `<div class="operating">
                                                 <span class="eta-detail seq${isFirst ? '1' : etaSeq}" data-eta="${etaText}" data-stop-seq="${stopSeq}">${millisToMinutesAndSeconds(etaText, stopSeq)}</span>
                                                 ${rmk}
                                              </div>`;
                                isFirst = false;
                            }
                        });


                        $(`#${id}-refresh`).html("ÊúÄÂæåÊõ¥Êñ∞: " + getTimeFromTimestamp(jsonData.generated_timestamp));
                        $(`#${id}`).removeClass("bus-stop");
                        $(`#${id}`).show();
                        $(`#${id}`).html(html);

                        if (refreshMap[id + '-eta'] === undefined) {
                            if (refreshMap[id + '-stopEta']  !== undefined) {
                                clearInterval(refreshMap[id + '-stopEta']);
                                delete refreshMap[id + '-stopEta'];
                            }

                            var interval = setInterval(function() { getRouteETA(route, bound, serviceType, stop, seq); }, refreshInterval);
                            refreshMap[id + '-eta'] = interval;
                        }
                   }
             }});
        }



        function getRouteBusStopETA(stop) {
            const id = '0-' + stop;

            $.ajax({url: `https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/${stop}`, cache: false, success: 
                function (data) {
                    const jsonData = data;
                    const currentTimestamp = jsonData.generated_timestamp;

                    const records = jsonData.data;
                    if (records.length > 0) {
                        const currentRoute = "";
                        const routeSet = new Set();
                        var html = '';
                        $.each(records, function (index, record) {
                            const route = record.route;
                            const dir = record.dir;
                            const etaSeq = record.eta_seq;
                            const eta = record.eta;
                            const stopSeq = record.seq;
                            const rmk = record.rmk_tc;
                            const dest = record.dest_tc;
                            const serviceType = record.service_type;
                            const dataTimestamp = record.data_timestamp;
                            const routeSetId = route + "-" + dir + "-" + etaSeq;

                            if (!routeSet.has(routeSetId)) {
                                var etaText;
                                if (eta) etaText = eta;
                                else if (rmk != "Êö´ÂÅúÈ†êÂ†±") etaText = "Êö´ÊôÇÊ≤íÊúâÈ†êÂÆöÁè≠Ê¨°";
                                html += `<div class="etaStop-seq-${etaSeq} ${!eta ? 'end' : 'operating'}">
                                                  <span class="eta-detail-route">${route}</span>
                                                  ‚ûî${dest}
                                                  <span class="eta-detail seq${etaSeq}" data-eta="${etaText}" data-stop-seq="${stopSeq}">${millisToMinutesAndSeconds(etaText, stopSeq)}</span>
                                                  ${rmk}
                                              </div>`;
                                routeSet.add(routeSetId);
                            }
                        });

                        $(`#${id}-refresh`).html("ÊúÄÂæåÊõ¥Êñ∞: " + getTimeFromTimestamp(jsonData.generated_timestamp));
                        $(`#${id}`).addClass("bus-stop");
                        $(`#${id}`).show();
                        $(`#${id}`).html(html);
                   }
             }});
        }


        function initBusStop() {
            $('#loadingDiv').show();
            $.getJSON("https://data.etabus.gov.hk/v1/transport/kmb/stop",
                function (data) {
                    const jsonData = data;

                    const records = jsonData.data;
                    $.each(records, function (index, record) {
                        const stop = record.stop;
                        const name = record.name_tc;
                        const nameEn = record.name_en;
                        const lat = record.lat;
                        const long = record.long;

                        busStopMap[stop] = { 'name': name, 'nameEn': nameEn, 'lat': lat, 'long': long };


                        //Add to map
                        var groupName = name;
                        var groupNameEn = nameEn;
                        var platform = null;

                        var platform = name.match(regex);
                        if (platform) {
                            platform = platform[0];
                            groupName = name.replace(platform, '').trim();
                            groupNameEn = nameEn.replace(platform, '').trim();

                            platform = platform.replace('(', '').replace(')', '').trim();
                            groupName = groupName + "(" + platform[0] + ")";
                            groupNameEn = groupNameEn + "(" + platform[0] + ")";
//if (platform.substr(1) == "11") console.log(groupName + platform);
                        }

                        var busStopGroupList = busStopGroupMap[groupName];
                        if (busStopGroupList == undefined) {
                            busStopGroupList = [];
                            busStopGroupMap[groupName] = busStopGroupList;
                        }

                        if (platform == null || busStopGroupList.length == 0) {
                            busStopGroupList.push({'stop': stop, 'nameEn': groupNameEn, 'lat': lat, 'long': long, 'platform': platform });
                        } else {
                            var i = 0;
                            for (; i < busStopGroupList.length; i++) {
                                if (parseInt(platform.substr(1)) <= parseInt(busStopGroupList[i].platform.substr(1))) {
                                    break;
                                }
                            }
                            busStopGroupList.splice(i, 0, {'stop': stop, 'nameEn': groupNameEn, 'lat': lat, 'long': long, 'platform': platform });
                        }
                    });


                   const paramRoute = findGetParameter("route");
                   const paramStop = findGetParameter("stop");
                   if (paramRoute) {
                       getRouteList();
                       searchValue = paramRoute;
                   } else if (paramStop) {
                      getBusStopList();
                       searchValue = paramStop;
                   } else {
                       getRouteList();
                   }
             });
        }


        function initDataTable(id) {
            if ($.fn.DataTable.isDataTable(id))
                $(id).DataTable().destroy();

            $(id).DataTable({
                "order": [],
                paging: true,
                "info": false,
                "columnDefs": [
                    { "className": "dt-center", "targets": "_all" }
                ],
                "search": {
                    "search": searchValue
                },
                "initComplete": function( settings, json ) {
                    if (searchValue) {
                        $("tr")[1].click();
                        searchValue = "";
                    } else {
                        $('.bus-eta-page .dataTables_wrapper .dataTables_filter input').focus()
                    }
                }
            });


            $('#menu-button').show();
        }

        function clearRefreshMap() {
            for (const [key, value] of Object.entries(refreshMap)) {
                clearInterval(refreshMap[key]);
                delete refreshMap[key];
            }
        }

        $(document).ready(function () {
            getLocation();
            initBusStop();
            
            const updateTimeGapInterval = setInterval(updateTimeGap , 1000);
        });


        $(document).ajaxStart(function () {
            //$('#loadingDiv').show();
        });

        $(document).ajaxComplete(function () {
            $('#loadingDiv').hide();
        });


        function updateTimeGap() {
            const currentDateTime = new Date();
            $(".eta-detail").each(function() {
                const stopSeq = $(this).attr("data-stop-seq");
                const eta = $(this).attr("data-eta");
                $(this).html(millisToMinutesAndSeconds(eta, stopSeq));
            });
        }

        function getTimeFromTimestamp(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours(); 
            const minutes = "0" + date.getMinutes();
            const seconds = "0" + date.getSeconds();
            const formattedTime = hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
            return formattedTime;
        }

        function millisToMinutesAndSeconds(eta, stopSeq) {
           if (eta) {
               const millis = new Date(eta) - new Date();
               if (millis > 0) { 
                   var minutes = Math.floor(millis / 60000);
                   var seconds = Math.floor(((millis % 60000) / 1000));
                   return minutes + "ÂàÜ" + (seconds < 10 ? '0' : '') + seconds+ "Áßí";
               } else if (!isNaN(millis)) {
                   return stopSeq == 1 ? "Â∑≤ÈñãÂá∫" : "Â∑≤Âà∞Á´ô";
               }
           }
           return eta;
        }


        function findGetParameter(parameterName) {
            var result = null,
            tmp = [];
            location.search.substr(1).split("&")
                .forEach(function (item) {
                    tmp = item.split("=");
                       if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
                });
           return result;
        }


        //This function takes in latitude and longitude of two location and returns the distance between them as the crow flies (in km)
        function calcCrow(lat2, lon2) 
        {
            var lat1 = userLat;
            var lon1 = userLng;
            if (lat1 == -1 || lon1 == -1) {
                return -1;
            } else {
                var R = 6371; // km
                var dLat = toRad(lat2-lat1);
                var dLon = toRad(lon2-lon1);
                var lat1 = toRad(lat1);
                var lat2 = toRad(lat2);

                var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2); 
                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
                var d = R * c; //KM
                var m = Math.round(d * 1000);
                return m;
             }
       }

        // Converts numeric degrees to radians
        function toRad(Value) 
        {
            return Value * Math.PI / 180;
        }


        //function that gets the location and returns it
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
            } else {
                console.log("Geo Location not supported by browser");
            }
        }
        //function that retrieves the position
        function showPosition(position) {
            var location = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude
            }
            console.log(location);
            userLat = location.latitude;
            userLng = location.longitude;
        }

        function initMap() {
            if (!leafletMap) {
                leafletMap = L.map('leaflet-map', {
                    attributionControl: false,
                    zoomControl: true,
                });
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(leafletMap);
            }
       }

       function setMapDefaultView() {
           leafletMap.setView([22.3493, 114.1694], 10);
       }

       function clearMarkersFromMap() {
           if (leafletMap) {
               leafletMapMarkerMap = {};
               leafletMap.eachLayer(function(layer) {
                   if (layer instanceof L.Marker) {
                       leafletMap.removeLayer(layer)
                   }
               })
            }
       }

       function addMarkersToMap(points) {
           const markerIcon = L.icon({
               iconSize: [30, 48],
               iconAnchor: [15, 48],
               popupAnchor:  [15, 0]
               iconUrl: "image/marker-icon.png"
           });

           // adding all markers to the featureGroups array
           let featureGroups = [];
           for (let i = 0; i < points.length; i++) {
               const [lat, lng, title] = points[i];
               const marker = L.marker([lat, lng], {opacity: 1.0, icon: markerIcon}).bindPopup(title);
               leafletMapMarkerMap[title] = marker;
               featureGroups.push(marker);
           }

           // adding all markers to the map
           for (let i = 0; i < featureGroups.length; i++) {
               featureGroups[i].addTo(leafletMap);
           }

           // Extended `LayerGroup` that makes it easy to do the same for all layers of its members
           const group = new L.featureGroup(featureGroups);

          // method fitBounds sets a map view that contains the given geographical bounds
          leafletMap.fitBounds(group.getBounds(), {
              padding: [20, 20], // adding padding to map
          });
       }

       function selectMarker(title) {
           const marker = leafletMapMarkerMap[title];
           if (marker) {
               marker.openPopup();
               leafletMap.setView(marker._latlng, 15);
           }
       }


    </script>
</head>

<body class="bus-eta-page">
    <div id="menu-button">
        <button onclick="getRouteList()">Â∑¥Â£´Ë∑ØÁ∑ö</button>
        <button onclick="getBusStopList()">Â∑¥Â£´Á´ô</button>
    </div>
    <br/>
    <div id="loadingDiv">
        Loading...
    </div>
    <div>
        <table id="listTable" class="dataTable display"></table>
        <div id="leaflet-map" style="height:200px"></div>
        <div class="busRouteInfo">
            <span id="busRouteInfo-Title"></span>
            <span class="busRouteInfo-Data" id="busRouteInfo-Data"></span>
            <div id="busStopList"></div>
        </div>
    </div>

    <object type="text/html" data="footer.html"></object>
</body>

</html>
