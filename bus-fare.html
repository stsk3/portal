<html>

<head>    
    <link rel="stylesheet" href="main.css">
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css" />
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>

    <script>

        /**
         * mode: B / F
         * interchangeType: 1 / 2
         **/
        function getJson(routeNum, mode, interchangeType) {
            const type = (mode == "F" ? 'Go' : 'Back');
            const tableId = '#result' + type + 'Table';
            const spanId = '#result' + type + 'Span';

            //Destroy old data
            $(tableId + " > tbody").html("");

            $(spanId).html("");

            $.getJSON(`http://whateverorigin.org/get?url=${encodeURIComponent(
                'https://www.kmb.hk/ajax/BBI/get_BBI2.php?routeno=' + routeNum + '&bound=' + mode + '&jtSorting=sec_routeno%20ASC&interchangeType=' + interchangeType)}`, function (data) {
                    const jsonData = JSON.parse(data.contents);

                    if (jsonData.Result == "OK") {
                        const place = jsonData.bus_arr[0].dest;
                        const records = jsonData.Records;

                        var html = '<thead>';
                        html += '<tr>';

                        var flag = 0;
                        $.each(records[0], function (index, value) {
                            if (index != "detail" && index != "spec_remark_eng")
                                html += '<th>' + fixHeader(index) + '</th>';
                        });
                        html += '</tr>';
                        html += '</thead>';

                        html += '<tbody>';
                        $.each(records, function (index, value) {
                            html += '<tr>';
                            $.each(value, function (index2, value2) {
                                if (index2 != "detail" && index2 != "spec_remark_eng") {
                                    html += '<td>' + value2 + '</td>';
                                }
                            });
                            html += '</tr>';
                        });
                        html += '</tbody>';


                        $(tableId).html(html);
                        $(spanId).html(place);

                        initDataTable(tableId);
                    }
                }
            );
        }

        function fixHeader(code) {
            switch (code) {
                case 'sec_routeno': return "路線";
                case 'sec_dest': return "往";
                case 'xchange': return "站";
                case 'validity': return "備註";
                case 'detail': return "detail";
                case 'discount_max': return "優惠";
                case 'spec_remark_eng':
                case 'spec_remark_chi': return "詳情";
                default: return ""
            }
        }

        function getResult(interchangeType) {
            const routeNum = $("#route-num").val().toUpperCase();
            getJson(routeNum, 'F', interchangeType);
            getJson(routeNum, 'B', interchangeType);
        }

        function initDataTable(id) {
            if ($.fn.DataTable.isDataTable(id))
                $(id).DataTable().destroy();

            $(id).DataTable({
                "order": [],
                paging: false,
                "info": false,
                "columnDefs": [
                    { "className": "dt-center", "targets": "_all" }
                ]
            });
        }

        $(document).ready(function () {
            $('#loadingDiv').hide();
            //initDataTable('#resultGoTable');
            //initDataTable('#resultBackTable');
        });


        $(document).ajaxStart(function () {
            $('#loadingDiv').show();
        });

        $(document).ajaxComplete(function () {
            $('#loadingDiv').hide();
        });


    </script>
</head>

<body>
    <div>
        <input id="route-num" type="text" placeholder="路線" value="74X">
        <button onclick="getResult(1)">第一程</button>
        <button onclick="getResult(2)">第二程</button>
    </div>
    <div>
        <a href="#resultGo">去程</a>
        <a href="#resultBack">回程</a>
    </div>

    <div id="loadingDiv">
        Loading...
    </div>
    <a id="resultGo"></a>
    <div>
        <br />
        <span>目的地: </span>
        <span id="resultGoSpan" class="bus-title"></span>
        <table id="resultGoTable" class="dataTable display"></table>
    </div>
    <br />
    <br />
    <hr>
    <a id="resultBack"></a>
    <div>
        <br />
        <span>目的地: </span>
        <span id="resultBackSpan" class="bus-title"></span>
        <table id="resultBackTable" class="dataTable display"></table>
    </div>
    <br />
    <br />
    <div>乘客用八達通卡繳付第一程車資後，除個別符號之指定時間外，乘客可於150分鐘內以同一張八達通卡繳付第二程車資，享受巴士轉乘優惠。<br/>
        ^: 30分鐘內<br/>
        #: 60分鐘內<br/>
        *: 90分鐘內<br/>
        @: 120分鐘內<br/>
        !: 適用於塘尾道或以後乘搭2A線之乘客
    </div>

    <object type="text/html" data="footer.html"></object>
</body>

</html>
