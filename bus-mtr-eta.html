<html>

<head>    
    <script type="text/javascript" src="script/jquery-3.3.1.js"></script>
    <link rel="stylesheet" href="script/jquery.dataTables.min.css" />
    <script type="text/javascript" src="script/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="transport/mtr_bus_route_list.js"></script>
    <link rel="stylesheet" href="main.css">
    <style></style>
    <script>
        const routeMap = mtrBusRotueMap;
        const refreshMap = {};  
        const refreshInterval = 30000;
        const showSet = new Set()

        
        var userLng = -1;
        var userLat = -1;


        function getRouteList() {
            $('.busRouteInfo').hide();
            $('#loadingDiv').show();

            const tableId = '#listTable';

            //Destroy old data
            $(tableId + " > tbody").html("");

            setTimeout(function(){ 
                var html = '<thead>';
                html += '<tr>';
                html += '<th>Ë∑ØÁ∑ö</th>';
                html += '<th>ÁõÆÁöÑÂú∞</th>';
                html += '</tr>';
                html += '</thead>';

                html += '<tbody>';
                for (const [routeName, value] of Object.entries(routeMap)) {
                    const desc = value.desc;
                    //const serviceType = value.service_type;

                    html += `<tr onclick="getRouteData('${routeName}')">`;
                    html += '<td class="highlight">' + routeName + '</td>';
                    html += '<td>' + desc + '</td>';
                    html += '</tr>';
                }
                html += '</tbody>';

                $(tableId).html(html);

                initDataTable(tableId);

                $('#loadingDiv').hide();
            }, 100);
       }


        function getRouteData(routeName) {
            clearRefreshMap();
            showSet.clear()

            const routeData = routeMap[routeName];

            $("#busRouteInfo-Title").html("Ë∑ØÁ∑ö: ");
            $("#busRouteInfo-Data").html(routeName + ": " + routeData.desc);
            $('.busRouteInfo').show();


            var html = `<div id="eta-${routeName}"></div>`;
            getRouteETA(routeName);

            $("#busStopList").html(html);
        }


        function getRouteETA(routeName) {      
            const mapPoints = [];
    
            $.ajax({url: `https://rt.data.gov.hk/v1/transport/mtr/bus/getSchedule`, cache: false, 
                         type: "POST", data: JSON.stringify({ routeName: routeName, language: "zh" }), contentType: "application/json; charset=utf-8", dataType: "json", success: 
                function (data) {
                    const jsonData = data;

                    var html = '';
                    var minDistance = 9999999;
                    var minDistanceSeq = -1;

                    const status = jsonData.status;
                    const systemTime = jsonData.routeStatusTime;
                    const routeStatus = jsonData.routeStatusRemarkContent;
                    const busStopList = jsonData.busStop;
                    if (busStopList.length > 0) {
                        $.each(busStopList, function (index, busStop) {
                            const seq = index + 1;
                            const busStopId = busStop.busStopId;          
                            const busStopName = busStopId;//TODO
                            const busStopLat = 0;//TODO
                            const busStopLong = 0;//TODO

                            const divId = busStopId;
                            const mapPopupName = busStopId;
                            mapPoints.push([busStopLat, busStopLong, mapPopupName]); 

                            const distance = calcCrow(busStopLat, busStopLong);
                            if (distance != -1 && distance < minDistance) {
                                minDistance = distance;
                                minDistanceSeq = seq;
                            }
                            html += `<div class="busStopDiv" id="busStopDiv-${seq}">
                                        <span>
                                            <span class="busStopDiv-seq">${seq}.</span>
                                            <span class="busStopDiv-name" onclick="showEtaDiv('${divId}'); selectMarker('${mapPopupName}');">${busStopName}</span>
                                            <span class="busStopDiv-map" onclick="window.open('https://maps.google.com/?q=${busStopLat},${busStopLong}', '_blank')">üìå</span>
                                            <span class="busStopDiv-distance">${distance != -1 ? distance + "Á±≥": ""}</span>
                                        </span>
                                    </div>`;

                            const busList = busStop.bus;
                            html += `<div id="${divId}" class="etaDiv">`;
                            if (busList.length > 0) {
                                var isFirst = true;
                                $.each(busList, function (index2, record) {
                                    const arrivalTimeInSecond = record.arrivalTimeInSecond;
                                    const arrivalTimeText = record.arrivalTimeText;
                                    const departureTimeInSecond = record.departureTimeInSecond;
                                    const departureTimeText = record.departureTimeText;
                                    const timeInSecond = arrivalTimeInSecond > 10000 ? departureTimeInSecond : arrivalTimeInSecond;
                                    const timeText = arrivalTimeInSecond > 10000 ? departureTimeText : arrivalTimeText;
                                    const etaSeq = index2 + 1;
                                    var etaText;
                                    if (timeInSecond) { etaText = new Date(systemTime); etaText.setSeconds(timeInSecond) }
                                    else etaText = "Êö´ÊôÇÊ≤íÊúâÈ†êÂÆöÁè≠Ê¨°";
                                    html += `<div class="operating">
                                                <span class="eta-detail seq${isFirst ? '1' : etaSeq}" data-eta="${etaText}" data-stop-seq="${seq}">${millisToMinutesAndSeconds(etaText, seq)}</span>
                                            </div>`;
                                    isFirst = false;
                                });
                            } else {
                                html += `<div class="operating"><div class="eta-detail seq1">${routeStatus ? routeStatus : "Êö´ÊôÇÊ≤íÊúâÈ†êÂÆöÁè≠Ê¨°"}</div></div>`;
                            }
                            html += `</div>`;

                    });
                } else {
                    html += `<div class="etaDiv show">`;
                    html += `<div class="operating"><div class="eta-detail seq1">${routeStatus ? routeStatus : "Êö´ÊôÇÊ≤íÊúâÈ†êÂÆöÁè≠Ê¨°"}</div></div>`;
                    html += `</div>`;
                }


                $(`#eta-refresh`).html("ÊúÄÂæåÊõ¥Êñ∞: " + getTimeFromTimestamp(systemTime));
                $(`#eta-${routeName}`).show();
                $(`#eta-${routeName}`).html(html);

                
                for (let divId of showSet) {
                    showEtaDiv(divId)
                }

                if (refreshMap[routeName] === undefined) {
                    var interval = setInterval(function() { getRouteETA(routeName); }, refreshInterval);
                    refreshMap[routeName] = interval;
                }
            }});
        }


        function showEtaDiv(divId) {
            let element = $(`#${divId}`);
            if (element.is(":visible")) {
                element.hide();
                showSet.delete(divId)
            }
            else {
                element.show();
                showSet.add(divId)
            }  
        }


        function initDataTable(id) {
            if ($.fn.DataTable.isDataTable(id))
                $(id).DataTable().destroy();

            $(id).DataTable({
                "pageLength": 20,
                "order": [[0, "asc"]],
                paging: true,
                "info": false,
                "columnDefs": [
                    { "className": "dt-center", "targets": "_all" }
                ]
            });

            $('.bus-eta-page .dataTables_wrapper .dataTables_filter input').focus()
        }

        function clearRefreshMap() {
            for (const [key, value] of Object.entries(refreshMap)) {
                clearInterval(refreshMap[key]);
                refreshMap[key] = undefined;
            }
        }

        

        //This function takes in latitude and longitude of two location and returns the distance between them as the crow flies (in km)
        function calcCrow(lat2, lon2) 
        {
            var lat1 = userLat;
            var lon1 = userLng;
            if (lat1 == -1 || lon1 == -1) {
                return -1;
            } else {
                var R = 6371; // km
                var dLat = toRad(lat2-lat1);
                var dLon = toRad(lon2-lon1);
                var lat1 = toRad(lat1);
                var lat2 = toRad(lat2);

                var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2); 
                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
                var d = R * c; //KM
                var m = Math.round(d * 1000);
                return m;
             }
       }

        // Converts numeric degrees to radians
        function toRad(Value) 
        {
            return Value * Math.PI / 180;
        }



        //function that gets the location and returns it
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
            } else {
                console.log("Geo Location not supported by browser");
            }
        }
        //function that retrieves the position
        function showPosition(position) {
            var location = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude
            }
            console.log(location);
            userLat = location.latitude;
            userLng = location.longitude;
        }

        $(document).ready(function () {
            getLocation();
            getRouteList();

            const updateTimeGapInterval = setInterval(updateTimeGap , 1000);
        });


        $(document).ajaxStart(function () {
            $('#loadingDiv').show();
        });

        $(document).ajaxComplete(function () {
            $('#loadingDiv').hide();
        });


        function updateTimeGap() {
            const currentDateTime = new Date();
            $(".eta-detail").each(function() {
                const stopSeq = $(this).attr("data-stop-seq");
                const eta = $(this).attr("data-eta");
                $(this).html(millisToMinutesAndSeconds(eta, stopSeq));
            });
        }

        function getTimeFromTimestamp(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours(); 
            const minutes = "0" + date.getMinutes();
            const seconds = "0" + date.getSeconds();
            const formattedTime = hours + ':' + minutes.substr(-2)+ ':' + seconds.substr(-2);
            return formattedTime;
        }
        

        function millisToMinutesAndSeconds(eta, stopSeq) {
            if (eta) { 
                const millis = (eta instanceof Date ? eta : new Date(eta)) - new Date();
                if (millis > 0) { 
                    var minutes = Math.floor(millis / 60000);
                    var seconds = Math.floor(((millis % 60000) / 1000));
                    return minutes + "ÂàÜ" + (seconds < 10 ? '0' : '') + seconds+ "Áßí";
                } else if (!isNaN(millis)) {
                    return stopSeq == 1 ? "Â∑≤ÈñãÂá∫" : "Â∑≤Âà∞Á´ô";
                }
            }
            return eta;
        }



        function selectMarker(title) {
            
        }

    </script>
</head>

<body class="bus-eta-page">
    <br/>
    <div id="loadingDiv">
        Loading...
    </div>
    <div>
        <table id="listTable" class="dataTable display"></table>
        <div class="busRouteInfo">
            <span id="busRouteInfo-Title"></span>
            <span class="busRouteInfo-Data" id="busRouteInfo-Data"></span>
            <div id="eta-refresh" class="refreshDiv">Êõ¥Êñ∞‰∏≠...</div>
            <div id="busStopList"></div>
        </div>
    </div>

    <object type="text/html" data="footer.html"></object>
</body>

</html>
