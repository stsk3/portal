<html>
<head>
    <link rel="stylesheet" href="main.css">
    <script type="text/javascript" src="serviceworker.js"></script>
    <script type="text/javascript" src="script/jquery-3.3.1.js"></script>



    <script>
	    document.addEventListener("DOMContentLoaded", function(event) { 
			$.ajaxSetup({ cache: false });
			getCurrentVersion();
			getCurrentWeather();
		});

        function getCurrentWeather() {
            $.getJSON('https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=warnsum&lang=tc',
                function (data) {
                    const jsonData = data;
                    var signalList = "";
                    Object.keys(jsonData).forEach(function(key) {
                        const code = data[key].code;
                        const name = data[key].name;
                        const type = data[key].type;
                        const actionCode = data[key].actionCode;
                        const issueTime = data[key].issueTime;
                        const updateTime = data[key].updateTime;
                        //signalList += (type ? type:"") + name + " ";

                        //icon
                        var icon = "";
                        switch (code) {
                            case 'WFIREY': icon = "firey"; break;
                            case 'WFIRER': icon = "firer"; break;
                            case 'WFROST': icon = "frost"; break;
                            case 'WHOT': icon = "vhot"; break;
                            case 'WCOLD': icon = "cold"; break;
                            case 'WMSGNL': icon = "sms"; break;
                            case 'WRAINA': icon = "raina"; break;
                            case 'WRAINR': icon = "rainr"; break;
                            case 'WRAINB': icon = "rainb"; break;
                            case 'WFNTSA': icon = "ntfl"; break;
                            case 'WL': icon = "landslip"; break;
                            case 'TC1': icon = "tc1"; break;
                            case 'TC3': icon = "tc3"; break;
                            case 'TC8NE': icon = "tc8ne"; break;
                            case 'TC8SE': icon = "tc8b"; break;
                            case 'TC8NW': icon = "tc8d"; break;
                            case 'TC8SW': icon = "tc8c"; break;
                            case 'TC9': icon = "tc9"; break;
                            case 'TC10': icon = "tc10"; break;
                            case 'WTMW': icon = "tsunami-warn"; break;
                            case 'WTS': icon = "ts"; break;
                            default: break;
                        }

                        //issueTime
                        const issueTimeObj = new Date(issueTime);
                        const formattedIssueTime = new Date(issueTimeObj.getTime() - (issueTimeObj.getTimezoneOffset() * 60000)).toISOString().replace(/\..+/, '').slice(5, -3).replace(/-/, '月').replace(/T/, '日');

                        signalList += `<span class="tooltip"><img src="https://www.hko.gov.hk/tc/wxinfo/dailywx/images/${icon}.gif"/><span class="tooltiptext">${formattedIssueTime}發出</span></span>`;
                    })
                    $('#signal-bar').html(signalList);
                }
            );

            $.getJSON('https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=swt&lang=tc',
                function (data) {
                    const jsonData = data;

                    var swtList = "";
                    const swtArray = jsonData.swt;
                    for(var i = 0; i < swtArray.length; i++) {
                        var swtObj = swtArray[i];
                        var desc = swtObj.desc;
                        swtList += (i == 0 ? "" : "<br/>") + `<a href="https://www.hko.gov.hk/tc/sweather_tips.html" target="_blank">${desc}</a>`;
                    }
                    $('#swt-bar').html(swtList);

                }
            );

            $.getJSON('https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=rhrread&lang=tc',
                function (data) {
                    const jsonData = data;

                    const icon = jsonData.icon[0];
                    var temperatureTp = "";
                    var temperatureYl = "";

                    const temperatureArray = jsonData.temperature.data;
                    for(var i = 0; i < temperatureArray.length; i++) {
                        var temperatureObj = temperatureArray[i];
                        var place = temperatureObj.place;
                        if (place == "大埔")
                            temperatureTp = temperatureObj.value;
                        if (place == "元朗公園")
                            temperatureYl = temperatureObj.value;
                    }

                    $("#weather-icon").attr("src", `https://www.hko.gov.hk/images/HKOWxIconOutline/pic${icon}.png`);
                    $('#temperature').html("大埔: " + temperatureTp + "°C" + "<br/>" + "元朗: " + temperatureYl + "°C");
                }
            );
        }

        function getCurrentVersion() {
            $.get('latestVersion.txt',
                function (data) {
                    var version = "v" + swVersion;
                    if (data != swVersion) {
                        version += "(舊版本)";
                    }
                    $('#version').html(version);
                }
            );
        }
    </script>
</head>

<body class="home-page">

    <div id="weather-bar">
        <span id="version"></span>
        <span id="signal-bar"></span>
        <div id="swt-bar"></div>
    </div>

    <div class="grid-container">
        <a href="weather.html" class="blue"><img src="image/home-icon/weather.png" id="weather-icon">天氣<br/><span id="temperature"></span></a>
        <a href="bus-interchange.html" class="light-red"><img src="image/home-icon/bus_sectional_fare.png">九巴轉乘優惠</a>
        <a href="mtr-lr-eta.html" class="red"><img src="image/home-icon/mtr_lr_eta.png">輕黨鐡到站時間</a>
        <a href="bus-kmb-eta.html" class="light-green"><img src="image/home-icon/bus_kmb_eta.png">九巴到站時間</a>
        <a href="hospital.html" class="light-red"><img src="image/home-icon/hospital.png">急症室等候時間</a>
        <a href="bus-sectional-fare.html" class="light-blue"><img src="image/home-icon/bus_interchange.png">九巴區域性<br/>雙向分段收費計劃</a>
        <a href="kfc/index.html" class="red" target="_top"><img src="image/home-icon/kfc.png">KFC會員</a>
        <a href="mcl/index.html" class="orange" target="_top"><img src="image/home-icon/mcl.png">MCL會員</a>
        <a href="https://www.handmadelicacy.com.hk" class="green" target="_blank"><img src="image/home-icon/hmd.png">知味手作</a>
	</div>

</body>

</html>
